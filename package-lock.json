const express = require('express');
const path = require('path');
const cors = require('cors');
const bodyParser = require('body-parser');

const app = express();
const PORT = process.env.PORT || 8080;

// ä¸­é—´ä»¶
app.use(cors());
app.use(bodyParser.json());
app.use(express.static(path.join(__dirname, './public')));

// æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨ï¼ˆå†…å­˜æ•°æ®åº“ï¼‰
let orders = [];
let menu = [
    { _id: '1', name: "çˆ±å¿ƒç…è›‹", emoji: "ğŸ³", price: 10, category: "breakfast", isApproved: true },
    { _id: '2', name: "æµªæ¼«æ„é¢", emoji: "ğŸ", price: 25, category: "lunch", isApproved: true },
    { _id: '3', name: "ç”œèœœä¸‰æ˜æ²»", emoji: "ğŸ¥ª", price: 15, category: "breakfast", isApproved: true }
];
let wallet = { balance: 100 };
let messages = [];

// æ·»åŠ æ—¥å¿—ä¸­é—´ä»¶
app.use((req, res, next) => {
    console.log(`${new Date().toISOString()} ${req.method} ${req.url}`);
    next();
});

// --- API æ¥å£ ---
app.get('/api/health', (req, res) => {
    res.json({ status: 'ok', message: 'æƒ…ä¾£å¨æˆ¿æœåŠ¡å™¨è¿è¡Œæ­£å¸¸' });
});

// é’±åŒ…æ¥å£
app.get('/api/wallet', async (req, res) => {
    res.json(wallet);
});

app.post('/api/wallet/recharge', async (req, res) => {
    const { amount } = req.body;
    if (amount && amount > 0) {
        wallet.balance += parseFloat(amount);
        res.json({ success: true });
    } else {
        res.status(400).json({ success: false, message: "æ— æ•ˆçš„é‡‘é¢" });
    }
});

// èœå•æ¥å£
app.get('/api/menu', async (req, res) => {
    res.json(menu);
});

app.post('/api/menu', async (req, res) => {
    const newDish = {
        _id: Date.now().toString(),
        ...req.body,
        createdAt: new Date()
    };
    menu.push(newDish);
    res.json(newDish);
});

app.put('/api/menu/:id', async (req, res) => {
    const id = req.params.id;
    const index = menu.findIndex(d => d._id === id);
    if (index !== -1) {
        menu[index] = { ...menu[index], ...req.body };
        res.json(menu[index]);
    } else {
        res.status(404).json({ success: false, message: "èœå“æœªæ‰¾åˆ°" });
    }
});

app.delete('/api/menu/:id', async (req, res) => {
    const id = req.params.id;
    const index = menu.findIndex(d => d._id === id);
    if (index !== -1) {
        const deleted = menu.splice(index, 1)[0];
        res.json(deleted);
    } else {
        res.status(404).json({ success: false, message: "èœå“æœªæ‰¾åˆ°" });
    }
});

// è®¢å•éªŒè¯ä¸­é—´ä»¶
const validateOrder = (req, res, next) => {
    const { items } = req.body;
    if (!items || !Array.isArray(items) || items.length === 0) {
        return res.status(400).json({ 
            success: false, 
            message: "è®¢å•ä¸èƒ½ä¸ºç©º" 
        });
    }
    next();
};

// è®¢å•æ¥å£
app.post('/api/order', validateOrder, async (req, res) => {
    try {
        const { items } = req.body;
        
        // æ›´å®‰å…¨çš„æ•°å€¼è®¡ç®—
        const total = items.reduce((sum, i) => {
            const price = parseFloat(i.price) || 0;
            const quantity = parseInt(i.quantity) || 0;
            return sum + (price * quantity);
        }, 0);
        
        // éªŒè¯æ€»é‡‘é¢
        if (total <= 0) {
            return res.status(400).json({ 
                success: false, 
                message: "è®¢å•é‡‘é¢æ— æ•ˆ" 
            });
        }
        
        // æ›´å‹å¥½çš„ä½™é¢ä¸è¶³æç¤º
        if (wallet.balance < total) {
            return res.status(400).json({ 
                success: false, 
                message: `ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢: ï¿¥${wallet.balance.toFixed(2)}ï¼Œéœ€è¦: ï¿¥${total.toFixed(2)}` 
            });
        }
        
        // æ‰£æ¬¾
        wallet.balance = parseFloat((wallet.balance - total).toFixed(2));
        
        // åˆ›å»ºè®¢å•
        const order = {
            _id: Date.now().toString(),
            items,
            totalPrice: total,
            status: 'waiting',
            rating: 0,
            createdAt: new Date()
        };
        
        orders.push(order);
        res.json({ success: true, order });
    } catch (error) {
        console.error('ä¸‹å•å¤±è´¥:', error);
        res.status(500).json({ 
            success: false, 
            message: "ä¸‹å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•" 
        });
    }
});

app.get('/api/orders', async (req, res) => {
    // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
    const sortedOrders = [...orders].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    res.json(sortedOrders);
});

app.put('/api/order/:id', async (req, res) => {
    const id = req.params.id;
    const index = orders.findIndex(o => o._id === id);
    if (index !== -1 && req.body.status) {
        orders[index].status = req.body.status;
        res.json(orders[index]);
    } else {
        res.status(404).json({ success: false, message: "è®¢å•æœªæ‰¾åˆ°" });
    }
});

app.put('/api/order/:id/rate', async (req, res) => {
    const id = req.params.id;
    const { rating } = req.body;
    const index = orders.findIndex(o => o._id === id);
    
    if (index !== -1 && rating >= 1 && rating <= 5) {
        orders[index].rating = rating;
        res.json(orders[index]);
    } else {
        res.status(400).json({ success: false, message: "æ— æ•ˆçš„è¯„åˆ†" });
    }
});

// æ¶ˆæ¯æ¥å£
app.get('/api/messages', async (req, res) => {
    // é™åˆ¶è¿”å›50æ¡æ¶ˆæ¯ï¼ŒæŒ‰æ—¶é—´æ­£åºæ’åˆ—
    const sortedMessages = [...messages]
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt))
        .slice(-50);
    res.json(sortedMessages);
});

app.post('/api/messages', async (req, res) => {
    const { sender, content } = req.body;
    if (!sender || !content) {
        return res.status(400).json({ 
            success: false, 
            message: "å‘é€è€…å’Œå†…å®¹ä¸èƒ½ä¸ºç©º" 
        });
    }
    
    const message = {
        _id: Date.now().toString(),
        sender,
        content,
        createdAt: new Date()
    };
    
    messages.push(message);
    res.json(message);
});

// é¡µé¢è·¯ç”±
app.get('/chef', (req, res) => {
    res.sendFile(path.join(__dirname, './public/chef.html'));
});

app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, './public/index.html'));
});

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼ˆæ”¾åœ¨æœ€åï¼‰
app.use((err, req, res, next) => {
    console.error('æœåŠ¡å™¨é”™è¯¯:', err);
    res.status(500).json({ success: false, message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' });
});

app.listen(PORT, () => {
    console.log(`ğŸš€ æƒ…ä¾£å¨æˆ¿æœåŠ¡å™¨è¿è¡Œä¸­: ${PORT}`);
    console.log(`ğŸ“± è®¿é—®åœ°å€ï¼šhttp://localhost:${PORT}`);
    console.log(`ğŸ‘¨â€ğŸ³ å¤§å¨é¢æ¿ï¼šhttp://localhost:${PORT}/chef`);
});
